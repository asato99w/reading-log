# 第25章：Visitor（動作パターン）

## 章の概要
オブジェクト構造の要素上で実行される操作を表現し、操作するクラスを変更せずに新しい操作を定義できるようにします。

## 主な内容

### 意図と構造
- オブジェクト構造のクラスを変更せずに新しい操作を定義
- 異なる具象要素タイプで異なる操作を実行可能
- 関連操作をVisitorクラスにまとめ、それらを使用する要素から分離
- Double Dispatchを実装して適切なVisitorメソッドを選択

### パターン参加者
- **Visitor**：オブジェクト構造の各ConcreteElementクラスのvisitメソッドを宣言
- **ConcreteVisitor**：各Visitメソッドを実装し、ConcreteElementクラスごとに対応する操作を定義
- **Element**：Visitorを引数とするacceptメソッドを宣言
- **ConcreteElement**：Visitorを引数とするacceptメソッドを実装
- **ObjectStructure**：要素を列挙し、visitorsが要素を訪問するための高レベルインターフェースを提供

### 実装上の考慮事項
- Acceptメソッドはvisitor.visit(this)を呼び出してdouble dispatchを実装
- Visitorは各ConcreteElementクラス用の訪問メソッドを持つべき
- ConcreteVisitorクラスは関連操作を一緒にグループ化
- 多くのConcreteElementクラスがある場合、Visitorインターフェースが大きくなる

### Double Dispatchメカニズム
- **第1ディスパッチ**：オペレーションが要素タイプで実行される場合（visitでなくaccept）
- **第2ディスパッチ**：オペレーションがvisitorタイプで実行される場合（visit）
- この機能により適切なVisitorメソッドが各要素タイプに対して選択される
- 単一ディスパッチ言語でも真のダブルディスパッチを実現

### 適用例
- **構文木操作**：コンパイラーでの異なる構文ノードに対する様々な操作
- **ファイルシステム**：ディレクトリ、ファイル、ショートカットに対する統計計算
- **UIコンポーネント**：ボタン、テキストフィールド、ラベルに対するレンダリング操作
- **数学式評価**：四則演算ノードに対する評価、微分、出力操作

## 重要ポイント
- **操作分離**：Visitorはオブジェクト構造から操作を分離し、要素クラス変更なしに新操作の追加を可能
- **関連操作グループ化**：ConcreteVisitorクラスが関連操作をまとめ、それらをデータ構造から分離
- **Double Dispatch**：要素タイプとvisitorタイプ両方に基づいて適切なメソッドが選択される強力なメカニズムを提供